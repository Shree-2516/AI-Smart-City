<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Report History</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

<nav class="navbar navbar-dark bg-dark">
    <div class="container">
        <span class="navbar-brand">Smart City â€“ Report History</span>
        <a href="/" class="btn btn-outline-light">Back</a>
    </div>
</nav>

<div class="container my-4">

    <!-- ================= SUMMARY SECTION ================= -->
    <h3 class="mb-3">Overall Report Summary</h3>

    <div class="row text-center mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Total Reports</h6>
                    <h4>{{ stats.total_reports }}</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Total Garbage</h6>
                    <h4>{{ stats.total_garbage }}</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Total Potholes</h6>
                    <h4>{{ stats.total_pothole }}</h4>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>No Issue Reports</h6>
                    <h4>{{ stats.no_issue_reports }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= PIE CHART ================= -->
    <div class="row justify-content-center mb-5">
        <div class="col-md-4">
            <canvas id="summaryChart"></canvas>
        </div>
    </div>

    <!-- ================= DELETE ALL ================= -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Saved Reports</h3>
        <form action="/delete_all" method="post"
              onsubmit="return confirm('Delete ALL reports?')">
            <button class="btn btn-danger">Delete All Reports</button>
        </form>
    </div>

    <!-- ================= REPORT CARDS ================= -->
    {% if reports %}
        <div class="row">
            {% for r in reports %}
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100">

                        <img src="/{{ r.image_path }}"
                             class="card-img-top"
                             style="max-height:200px; object-fit:cover;">

                        <div class="card-body">
                            <p class="small text-muted">{{ r.created_at }}</p>

                            <p>
                                <strong>Issues:</strong><br>
                                {% if r.summary %}
                                    {% for k, v in r.summary.items() %}
                                        {{ v }} {{ k }}<br>
                                    {% endfor %}
                                {% else %}
                                    No issues detected
                                {% endif %}
                            </p>

                            <span class="badge
                                {% if r.severity == 'Low' %}bg-success
                                {% elif r.severity == 'Medium' %}bg-warning text-dark
                                {% else %}bg-danger{% endif %}">
                                Severity: {{ r.severity }}
                            </span>

                            <form action="/delete/{{ r.id }}" method="post"
                                  class="mt-3"
                                  onsubmit="return confirm('Delete this report?')">
                                <button class="btn btn-sm btn-outline-danger">
                                    Delete
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No reports found.</p>
    {% endif %}

</div>

<!-- Pass summary data safely -->
<script type="application/json" id="summaryData">
{
    "garbage": {{ stats.total_garbage }},
    "pothole": {{ stats.total_pothole }},
    "no_issue": {{ stats.no_issue_reports }}
}
</script>

<script>
const data = JSON.parse(
    document.getElementById("summaryData").textContent
);

const ctx = document.getElementById("summaryChart");

new Chart(ctx, {
    type: "pie",
    data: {
        labels: ["Garbage", "Pothole", "No Issue"],
        datasets: [{
            data: [
                data.garbage,
                data.pothole,
                data.no_issue
            ],
            backgroundColor: ["#dc3545", "#0d6efd", "#198754"]
        }]
    },
    options: {
        plugins: {
            legend: { position: "bottom" }
        }
    }
});
</script>


</body>
</html>
